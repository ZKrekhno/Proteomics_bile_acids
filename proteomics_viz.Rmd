---
title: "Visualizing Bile Acids Proteomics results"
output:
  pdf_document: 
    highlight: tango
  html_notebook: default
---

```{r lib-setup, echo=TRUE, warning=FALSE, message=FALSE}
library(clusterProfiler)
library(org.Hs.eg.db)
library(tidyverse)
library(readxl)
library(ggprism)
library(patchwork)
```

Set up parameters - like colors 
```{r setup}
div_pal <- rcartocolor::carto_pal(7, "Geyser")
```


```{r import}
mq <- read_tsv(here::here("normalyzer_limma_de_results_annotated.tsv"))
meta <- read_tsv(here::here("norm_meta.tsv"))
mq_res <- mq %>% 
  select(contains("Log"), contains("Adj"), contains("PValue"), contains("Majority"), contains("Gene"))
mq_mat <- mq %>% 
  select(`Gene names`, `Majority protein IDs`, matches("(C|L)[1-6](c|m)"))
#Convert the results table into a list and unify the columns names. 
#Invert the foldChanges, so that comparisons are L-C instead of C-L.
#Reduce Gene names to just one gene for analysis
mq_res_list <- list(select(mq_res, -contains("Cc-Lc")),
                    select(mq_res, -contains("Cm-Lm"))) %>% 
  set_names(nm = c("Membrane", "Cyto")) %>% 
  map(rename_with, ~str_remove(.,"C(c|m)-L(c|m)_") ,matches("C(c|m)-L(c|m)_")) %>% 
  map(mutate, across(contains("log2"), ~ -.x)) %>% 
  map(separate, `Gene names`, into = letters [1:2], extra = "drop", sep = ";") %>% 
  map(mutate, Genes = case_when(
    str_detect(a, "orf") & !is.na(b) & str_detect(b, "orf", negate = T) ~ b,
    TRUE ~ a
  ), Gene_rows = Genes) 
```
# Venn diagram

```{r venn}
#Filter results to only include DA proteins
da_list <- mq_res_list %>% 
  map(filter, AdjPVal < 0.05, abs(log2FoldChange) > 1)
#Pull just the Protein IDs for DA proteins
da_genes <- da_list %>% map(pull, `Majority protein IDs`) %>% 
  set_names(nm = c("Membrane-bound Proteins", "Cytosolic Proteins"))
ggvenn::ggvenn(da_genes, text_size = 10, set_name_size = 6,
               fill_color = c("indianred", "royalblue1"), show_percentage = F)
#ggsave(here::here("Euler diagram DA proteins.png"), units = "in", dpi = 720, width = 8, height = 6)
```
Get identities of common DE proteins
```{r intersect-de}
common_top <- da_genes %>% 
  reduce(intersect)
mq_intersect_top <- mq_res %>% 
  filter(`Majority protein IDs` %in% common_top) 
#write_csv(mq_intersect_top, here::here("Shared DE proteins.csv"))
```


# Volcano plots
```{r volcano, fig.width=8, fig.height=6.6}
#Add categories for signifcance
mq_res_volc_list <- mq_res_list %>% 
  map(mutate, 
      Significance = case_when(
        AdjPVal >= 0.05 | is.na(AdjPVal) ~ "Not Significant",
        AdjPVal < 0.05 & log2FoldChange > 0 ~ "Up (q<0.05)",
        AdjPVal < 0.05 & log2FoldChange < 0 ~ "Down (q<0.05)",
      )) %>% 
  map(mutate, 
      Significance = fct_relevel(Significance,"Not Significant","Up (q<0.05)","Down (q<0.05)"))

volcano_list <- mq_res_volc_list %>% 
  map2(c("Membrane-bound Proteins", "Cytosolic Proteins"), 
       ~ ggplot(.x, aes(x = log2FoldChange, y = -log10(PValue))) +
         geom_point(aes(fill = Significance, color = Significance), shape = 21, alpha = 0.5, size = 2.5) +
         scale_color_manual(values = c("grey85",div_pal [c(1,7)])) +
         scale_fill_manual(values = c("grey85",div_pal [c(1,7)])) + 
         labs(x = bquote(~Log[2] ~ "fold change"), y = bquote(~-Log[10] ~ italic(P)), title = .y) +
         theme_linedraw(base_size = 15) +
         theme(panel.grid = element_line(color =  "grey90"),
               panel.grid.major = element_line(linewidth = 0.7),
               panel.grid.minor = element_line(linewidth = 0.5),
               panel.border = element_rect(fill = NA, color = "black", linewidth = 0.9)))
walk(volcano_list, print)
#walk2(volcano_list, names(volcano_list), 
 #    ~ggsave(here::here(str_c("final results/volcano_plot_",.y,".png")), plot = .x, width = 8, height = 6.66, dpi = 1080))
```


# Functional enrichment
```{r cluster-enrich}
set.seed(711)
#Get the whole human genome as universe
human_genom <- org.Hs.egSYMBOL
mapped_genes <- mappedRkeys(human_genom)
h <- read.gmt(list.files(path = here::here("."),pattern = "h.all"))
c2_cp <- read.gmt(list.files(path = here::here("."),pattern = "c2.cp"))  
c2_kegg <- c2_cp %>% 
  filter(str_detect(term, "KEGG")) 
c2_react <- c2_cp %>% 
  filter(str_detect(term,"REACTOME"))
#Set up lists of genes for analysis
prots_list <- vector(mode = "list", length = 4) %>% 
  set_names(map_chr(cross2(c("Membrane-bound","Cytoplasmic"),c("Up","Down")), reduce, str_c, sep = "_"))
#THis loop not working !!!! FIX !!!
for(i in seq_along(prots_list)) {
  if (str_detect(names(prots_list) [i], "Membrane")) {
    res_dummy <- da_list [["Membrane"]]
    if (str_detect(names(prots_list) [i], "Up")) {
      prots_list [i] <- pull(filter(res_dummy, AdjPVal < 0.05, log2FoldChange > 0), var = "Genes")
    } else {
      prots_list [i] <- pull(filter(res_dummy, AdjPVal < 0.05, log2FoldChange < 0), var = "Genes")
    }
  } else {
    res_dummy <- da_list [["Cyto"]]
    if (str_detect(names(prots_list) [i], "Up")) {
      prots_list [i] <- pull(filter(res_dummy, AdjPVal < 0.05, log2FoldChange > 0), var = "Genes")
    } else {
      prots_list [i] <- pull(filter(res_dummy, AdjPVal < 0.05, log2FoldChange < 0), var = "Genes")
    }
  }
}


#Pull just the gene names for DA proteins



da_symbols <- 
  da_list %>% 
  
  map(pull, `Genes`) %>% 
  set_names(nm = c("Membrane-bound proteins", "Cytosolic proteins"))
enrich_h_list <- map(da_symbols, ~enricher(.,
                     TERM2GENE = h,
                     universe = mapped_genes,
                     pAdjustMethod = "BH",
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.05))
enrich_c2_list <- map(da_symbols, ~enricher(.,
                     TERM2GENE = c2_noID,
                     universe = mapped_genes,
                     pAdjustMethod = "BH",
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.05))
ego_bp <- map(da_symbols, ~enrichGO(gene = .,
                OrgDb         = org.Hs.eg.db,
                universe = mapped_genes,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05))
ego_bp <- map(ego_bp,enrichplot::pairwise_termsim)
ego_bp2 <- ego_bp %>% 
  map(~clusterProfiler::simplify(., cutoff=0.4, by="p.adjust", select_fun=min))
```

Plot the functional enrichment results

```{r cluster-plotting, fig.height=9, fig.width=7}
dot_titles <- rep(c("Hallmark geneset", "C2 Canonical Pathways", "GO BP"), each = 2) %>% 
  str_c(names(da_genes), sep = "\n")
#pdf(here::here("Functional enrichment analyses.pdf"), height = 9, width = 7)
walk2(c(enrich_h_list, enrich_c2_list, ego_bp2), dot_titles, 
      ~print(dotplot(.x, showCategory = 15) + ggtitle(.y)))
#dev.off()
```
# Session Info
```{r}
sessionInfo()
```


